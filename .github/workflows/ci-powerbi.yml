name: CI Power BI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-powerbi-project:
    name: Valider le projet Power BI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show repository tree (for debug)
        run: |
          echo "Contenu du dÃ©pÃ´t :"
          ls -la
          echo "Recherche des fichiers .pbip et .pbix :"
          ls -la *.pbip || true
          ls -la *.pbix || true

      - name: Validate project presence
        run: |
          echo "VÃ©rification que le projet Power BI est prÃ©sent (pbip OU pbix)â€¦"
          if ls *.pbip 1>/dev/null 2>&1; then
            echo "âœ… Fichier .pbip trouvÃ©."
          elif ls *.pbix 1>/dev/null 2>&1; then
            echo "âœ… Fichier .pbix trouvÃ©."
          else
            echo "âŒ Aucun fichier .pbip ou .pbix trouvÃ© Ã  la racine du dÃ©pÃ´t."
            exit 1
          fi

      - name: Validate pbip structure (dataset/report)
        run: |
          if ls *.pbip 1>/dev/null 2>&1; then
            echo "VÃ©rification de la structure pbipâ€¦"
            if test -d "dataset" || test -d "CI CD.SemanticModel"; then
              echo "âœ… Dossier dataset trouvÃ©."
            else
              echo "âŒ Aucun dossier dataset ou CI CD.SemanticModel trouvÃ©."
              exit 1
            fi
            if test -d "report" || test -d "CI CD.Report"; then
              echo "âœ… Dossier report trouvÃ©."
            else
              echo "âŒ Aucun dossier report ou CI CD.Report trouvÃ©."
              exit 1
            fi
          else
            echo "Projet en .pbix : Ã©tape de validation pbip sautÃ©e."
          fi

  check-parameters-and-measures:
    name: VÃ©rifier paramÃ¨tres et mesures
    runs-on: ubuntu-latest
    needs: validate-powerbi-project   # ce job ne sâ€™exÃ©cute que si la validation PBIP rÃ©ussit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: VÃ©rifier les paramÃ¨tres de connexion
        run: |
          echo "ContrÃ´le des paramÃ¨tres de connexion Power BI..."
          if grep -r '"ServerName":' . | grep -q 'IKRAM-PC'; then
            echo "âœ… ParamÃ¨tre ServerName trouvÃ© et correct."
          else
            echo "âŒ ParamÃ¨tre ServerName manquant ou incorrect."
            exit 1
          fi

          if grep -r '"DatabaseName":' . | grep -q 'ikram_dev'; then
            echo "âœ… ParamÃ¨tre DatabaseName trouvÃ© et correct."
          else
            echo "âŒ ParamÃ¨tre DatabaseName manquant ou incorrect."
            exit 1
          fi

      - name: VÃ©rifier la prÃ©sence de mesures DAX critiques
        run: |
          echo "VÃ©rification des mesures DAX critiques..."
          if grep -r '"name": "Total Sales"' .; then
            echo "âœ… Mesure DAX 'Total Sales' prÃ©sente."
          else
            echo "âš ï¸ Attention : mesure DAX 'Total Sales' manquante."
          fi
  quality-check:
    name: ContrÃ´le qualitÃ© DAX & M-Code
    runs-on: ubuntu-latest
    needs: check-parameters-and-measures  # sâ€™exÃ©cute aprÃ¨s la validation des paramÃ¨tres

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyser la qualitÃ© DAX et M-Code
        run: |
          echo "ðŸ” Analyse du code DAX et M..."
          echo "=== Rapport de validation Power BI ===" > validation-report.txt
          echo "Date d'analyse : $(date)" >> validation-report.txt
          echo "" >> validation-report.txt

          # VÃ©rification des fichiers de mesures
          if grep -r '"expression":' . | grep -q "CALCULATE"; then
            echo "âœ… Mesures DAX valides trouvÃ©es (utilisation de CALCULATE dÃ©tectÃ©e)" >> validation-report.txt
          else
            echo "âš ï¸ Aucune mesure DAX complexe dÃ©tectÃ©e" >> validation-report.txt
          fi

          # VÃ©rification du M code (Power Query)
          if grep -r "let" . | grep -q "in"; then
            echo "âœ… RequÃªtes Power Query dÃ©tectÃ©es (M code correct)" >> validation-report.txt
          else
            echo "âŒ Aucun M code valide dÃ©tectÃ©" >> validation-report.txt
          fi

          echo "" >> validation-report.txt
          echo "Analyse terminÃ©e avec succÃ¨s âœ…" >> validation-report.txt

      - name: Publier le rapport dâ€™analyse
        uses: actions/upload-artifact@v4
        with:
          name: rapport-validation-powerbi
          path: validation-report.txt
