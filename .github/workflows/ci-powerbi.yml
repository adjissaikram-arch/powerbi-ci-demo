name: CI Power BI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-powerbi-project:
    name: Valider le projet Power BI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show repository tree (for debug)
        run: |
          echo "Contenu du dépôt :"
          ls -la
          echo "Recherche des fichiers .pbip et .pbix :"
          ls -la *.pbip || true
          ls -la *.pbix || true

      - name: Validate project presence
        run: |
          echo "Vérification que le projet Power BI est présent (pbip OU pbix)…"
          if ls *.pbip 1>/dev/null 2>&1; then
            echo "✅ Fichier .pbip trouvé."
          elif ls *.pbix 1>/dev/null 2>&1; then
            echo "✅ Fichier .pbix trouvé."
          else
            echo "❌ Aucun fichier .pbip ou .pbix trouvé à la racine du dépôt."
            exit 1
          fi

      - name: Validate pbip structure (dataset/report)
        run: |
          if ls *.pbip 1>/dev/null 2>&1; then
            echo "Vérification de la structure pbip…"
            if test -d "dataset" || test -d "CI CD.SemanticModel"; then
              echo "✅ Dossier dataset trouvé."
            else
              echo "❌ Aucun dossier dataset ou CI CD.SemanticModel trouvé."
              exit 1
            fi
            if test -d "report" || test -d "CI CD.Report"; then
              echo "✅ Dossier report trouvé."
            else
              echo "❌ Aucun dossier report ou CI CD.Report trouvé."
              exit 1
            fi
          else
            echo "Projet en .pbix : étape de validation pbip sautée."
          fi

  check-parameters-and-measures:
    name: Vérifier paramètres et mesures
    runs-on: ubuntu-latest
    needs: validate-powerbi-project   # ce job ne s’exécute que si la validation PBIP réussit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Vérifier les paramètres de connexion
        run: |
          echo "Contrôle des paramètres de connexion Power BI..."
          if grep -r '"ServerName":' . | grep -q 'IKRAM-PC'; then
            echo "✅ Paramètre ServerName trouvé et correct."
          else
            echo "❌ Paramètre ServerName manquant ou incorrect."
            exit 1
          fi

          if grep -r '"DatabaseName":' . | grep -q 'ikram_dev'; then
            echo "✅ Paramètre DatabaseName trouvé et correct."
          else
            echo "❌ Paramètre DatabaseName manquant ou incorrect."
            exit 1
          fi

      - name: Vérifier la présence de mesures DAX critiques
        run: |
          echo "Vérification des mesures DAX critiques..."
          if grep -r '"name": "Total Sales"' .; then
            echo "✅ Mesure DAX 'Total Sales' présente."
          else
            echo "⚠️ Attention : mesure DAX 'Total Sales' manquante."
          fi
  quality-check:
    name: Contrôle qualité DAX & M-Code
    runs-on: ubuntu-latest
    needs: check-parameters-and-measures  # s’exécute après la validation des paramètres

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyser la qualité DAX et M-Code
        run: |
          echo "🔍 Analyse du code DAX et M..."
          echo "=== Rapport de validation Power BI ===" > validation-report.txt
          echo "Date d'analyse : $(date)" >> validation-report.txt
          echo "" >> validation-report.txt

          # Vérification des fichiers de mesures
          if grep -r '"expression":' . | grep -q "CALCULATE"; then
            echo "✅ Mesures DAX valides trouvées (utilisation de CALCULATE détectée)" >> validation-report.txt
          else
            echo "⚠️ Aucune mesure DAX complexe détectée" >> validation-report.txt
          fi

          # Vérification du M code (Power Query)
          if grep -r "let" . | grep -q "in"; then
            echo "✅ Requêtes Power Query détectées (M code correct)" >> validation-report.txt
          else
            echo "❌ Aucun M code valide détecté" >> validation-report.txt
          fi

          echo "" >> validation-report.txt
          echo "Analyse terminée avec succès ✅" >> validation-report.txt

      - name: Publier le rapport d’analyse
        uses: actions/upload-artifact@v4
        with:
          name: rapport-validation-powerbi
          path: validation-report.txt
