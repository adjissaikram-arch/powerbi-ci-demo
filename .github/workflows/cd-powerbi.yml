name: CD Power BI - D√©ploiement automatique

on:
  release:
    types: [published]  # Se d√©clenche quand une release/tag (ex: v1.0.0) est publi√©e

jobs:
  deploy-to-powerbi:
    runs-on: windows-latest
    name: D√©ployer sur Power BI Service

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Installer les modules Power BI
      shell: pwsh
      run: |
        Install-Module -Name MicrosoftPowerBIMgmt -Force -Scope CurrentUser
        Install-Module -Name MicrosoftPowerBIMgmt.Reports -Force -Scope CurrentUser
        Install-Module -Name MicrosoftPowerBIMgmt.Workspaces -Force -Scope CurrentUser

    - name: Authentifier via Azure AD et Power BI Service Principal
      shell: pwsh
      run: |
        $clientId = "${{ secrets.PBI_CLIENT_ID }}"
        $clientSecret = "${{ secrets.PBI_CLIENT_SECRET }}"
        $tenantId = "${{ secrets.PBI_TENANT_ID }}"

        Write-Host "üîê R√©cup√©ration du token Azure AD..."
        $body = @{
            grant_type    = "client_credentials"
            client_id     = $clientId
            client_secret = $clientSecret
            scope         = "https://analysis.windows.net/powerbi/api/.default"
        }

        $response = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -Body $body
        $token = $response.access_token

        Write-Host "‚úÖ Authentification r√©ussie, connexion √† Power BI Service..."
        Connect-PowerBIServiceAccount -AccessToken $token

    - name: D√©ployer le rapport Power BI
      shell: pwsh
      run: |
        $workspaceId = "${{ secrets.PBI_WORKSPACE_ID }}"
        $reportPath = "CI CD.pbix"

        Write-Host "üöÄ D√©ploiement du rapport $reportPath vers Power BI Service..."
        Import-Module MicrosoftPowerBIMgmt.Reports -ErrorAction Stop
        Import-Module MicrosoftPowerBIMgmt.Workspaces -ErrorAction Stop

        Import-PowerBIReport -Path $reportPath -WorkspaceId $workspaceId -Name "CI CD" -ConflictAction Overwrite

        Write-Host "‚úÖ D√©ploiement termin√© avec succ√®s !"
