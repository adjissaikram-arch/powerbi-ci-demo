name: CD Power BI - D√©ploiement automatique

on:
  release:
    types: [published]

jobs:
  deploy-to-powerbi:
    runs-on: windows-latest
    name: D√©ployer sur Power BI Service

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Installer et ex√©cuter le d√©ploiement Power BI
      shell: pwsh
      run: |
        Write-Host "--- Installation des modules Power BI ---"
        Install-Module -Name MicrosoftPowerBIMgmt -Force -Scope CurrentUser
        Install-Module -Name MicrosoftPowerBIMgmt.Reports -Force -Scope CurrentUser
        Install-Module -Name MicrosoftPowerBIMgmt.Workspaces -Force -Scope CurrentUser

        Write-Host "--- Importation des modules ---"
        Import-Module MicrosoftPowerBIMgmt
        Import-Module MicrosoftPowerBIMgmt.Reports
        Import-Module MicrosoftPowerBIMgmt.Workspaces

        # --- Variables ---
        $clientId = "${{ secrets.PBI_CLIENT_ID }}"
        $clientSecret = "${{ secrets.PBI_CLIENT_SECRET }}"
        $tenantId = "${{ secrets.PBI_TENANT_ID }}"
        $workspaceId = "${{ secrets.PBI_WORKSPACE_ID }}"
        $reportPath = "CI CD.pbix"

        # --- Authentification ---
        Write-Host "üîê Connexion √† Power BI Service..."
        $SecureSecret = ConvertTo-SecureString $clientSecret -AsPlainText -Force
        $Credential = New-Object System.Management.Automation.PSCredential($clientId, $SecureSecret)
        Connect-PowerBIServiceAccount -ServicePrincipal -Credential $Credential -Tenant $tenantId
        Write-Host "‚úÖ Authentification r√©ussie !"

        # --- V√©rification du fichier PBIX ---
        if (!(Test-Path $reportPath)) {
          Write-Error "‚ùå Le fichier $reportPath est introuvable dans le d√©p√¥t."
          exit 1
        }

        # --- Liste des modules disponibles ---
        Write-Host "üì¶ Modules Power BI charg√©s :"
        Get-Module MicrosoftPowerBIMgmt* -ListAvailable

        # --- V√©rification de la commande Import-PowerBIReport ---
        Write-Host "üîç V√©rification de la disponibilit√© de la commande Import-PowerBIReport..."
        Get-Command Import-PowerBIReport -ErrorAction SilentlyContinue

        # --- D√©ploiement du rapport ---
        Write-Host "üöÄ D√©ploiement du rapport $reportPath vers Power BI Service..."
        try {
          $report = Import-PowerBIReport -Path $reportPath -WorkspaceId $workspaceId -Name "CI CD" -ConflictAction Overwrite
          Write-Host "‚úÖ D√©ploiement termin√© avec succ√®s !"
        }
        catch {
          Write-Error "‚ùå √âchec du d√©ploiement du rapport : $($_.Exception.Message)"
          exit 1
        }
